<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlie's Collectibles</title>
    <!-- 1. Carga de TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilo para la fuente Inter (predeterminada en Tailwind) */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Pequeña animación para el spinner de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }
        /* Clases para el modal */
        .modal-open {
            overflow: hidden;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
    <script>
      // Configuración de Tailwind para modo oscuro (opcional, pero da un look 'collector')
      tailwind.config = {
        darkMode: 'class', // 'media' o 'class'
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          }
        }
      }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 antialiased min-h-screen">

    <!-- ==== 1. ENCABEZADO ==== -->
    <header class="container mx-auto px-4 py-8 text-center">
        <h1 class="text-4xl font-extrabold text-white mb-2">
            Charlie's Collectibles
        </h1>
        <p class="text-lg text-gray-400">
            Venta de colección personal (Funkos, Hot Wheels, Spheros y más).
        </p>
    </header>

    <!-- ==== 2. ESTADO DE CARGA (AHORA AUTOMÁTICO) ==== -->
    <section class="container mx-auto px-4 mb-8 max-w-2xl text-center">
        <!-- El spinner de carga y los mensajes de error aparecerán aquí -->
        <div id="loading-spinner" class="flex justify-center mt-4">
            <div class="spinner mx-auto"></div>
            <p class="ml-3">Cargando librerías...</p>
        </div>
        <div id="error-message" class="text-red-400 mt-3 hidden"></div>
    </section>

    <!-- ==== 3. GRID DE PRODUCTOS ==== -->
    <main class="container mx-auto px-4">
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
            <!-- Los productos se cargarán aquí dinámicamente -->
        </div>
    </main>

    <!-- ==== 4. BOTÓN FLOTANTE DEL CARRITO ==== -->
    <button id="open-cart-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all transform hover:scale-110 focus:outline-none z-40">
        <!-- Icono de Carrito (SVG) -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center">0</span>
    </button>

    <!-- ==== 5. MODAL DEL CARRITO (Oculto por defecto) ==== -->
    <div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-gray-800 w-full max-w-2xl max-h-[90vh] rounded-lg shadow-xl flex flex-col overflow-hidden">
            <!-- Cabecera del Modal -->
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h2 class="text-2xl font-bold">Tu Carrito</h2>
                <button id="close-cart-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            
            <!-- Items del Carrito (con scroll) -->
            <div id="cart-items" class="p-5 overflow-y-auto flex-grow">
                <!-- Los items del carrito se cargarán aquí -->
                <p class="text-gray-500">Aún no has agregado productos.</p>
            </div>
            
            <!-- Footer del Modal -->
            <div class="p-5 border-t border-gray-700 bg-gray-800">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Total:</span>
                    <span id="cart-total" class="text-2xl font-bold text-blue-400">$0.00</span>
                </div>
                <button id="generate-pdf-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-green-700 transition-colors duration-200" disabled>
                    Generar Pedido PDF
                </button>
                <p class="text-xs text-gray-500 mt-3 text-center">
                    Se generará un PDF con tu pedido. <strong>Debes enviarlo a <a href="https://www.instagram.com/charlie.leyva" target="_blank" class="text-blue-400 hover:underline">@charlie.leyva</a> en Instagram</strong> para coordinar pago y entrega.
                </p>
            </div>
        </div>
    </div>

    <!-- ==== 6. FOOTER DE LA PÁGINA ==== -->
    <footer class="container mx-auto px-4 py-8 mt-12 text-center text-gray-500 text-sm border-t border-gray-800">
        <p>Esta es una venta de colección personal. No se realizan transacciones en este sitio web.</p>
        <p>Los costos de envío se cobran por separado. Todos los derechos reservados &copy; 2025.</p>
    </footer>

    <!-- ==== 7. CARGA DE LIBRERÍAS EXTERNAS ==== -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>


    <!-- ==== 8. SCRIPT PRINCIPAL DE LA APLICACIÓN ==== -->
    <script>
        
        // --- ESTADO DE LA APLICACIÓN ---
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQesUdFDSmsouRvzmC7s7ShsWR1b8yTOGFbq-0R63Y5AsxprUip4sDslNFJ6-Xq-A/pub?output=csv";
        let allProducts = [];
        let cart = []; // Array de productos en el carrito
        let jsPDF; // Se declarará al iniciar

        // --- REFERENCIAS AL DOM ---
        const productGrid = document.getElementById('product-grid');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.querySelector('#loading-spinner p'); // Referencia al texto de carga
        const errorMessage = document.getElementById('error-message');
        
        // Carrito
        const openCartBtn = document.getElementById('open-cart-btn');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');

        // --- INICIALIZACIÓN ---
        
        // Implementación robusta que espera a que las librerías se carguen.
        window.onload = () => {
            let maxAttempts = 50; // 50 intentos * 100ms = 5 segundos
            let attempts = 0;

            function checkLibraries() {
                if (typeof Papa !== 'undefined' && typeof window.jspdf !== 'undefined') {
                    // ¡Éxito! Las librerías están cargadas.
                    initializeApp();
                } else if (attempts < maxAttempts) {
                    // Aún no están listas, reintentar en 100ms
                    attempts++;
                    setTimeout(checkLibraries, 100);
                } else {
                    // Se superó el tiempo, mostrar error
                    console.error("Timeout: PapaParse o jsPDF no se cargaron desde JSDelivr.");
                    showError("Error: No se pudieron cargar las librerías. Revisa tu conexión a internet y refresca la página.");
                    showLoading(false); // Ocultar spinner
                }
            }
            
            checkLibraries();
        };

        /**
         * Se llama ÚNICAMENTE cuando las librerías están confirmadas.
         */
        function initializeApp() {
            console.log("Librerías cargadas. Inicializando app...");
            
            // Asignar la librería cargada
            jsPDF = window.jspdf.jsPDF;

            // Cargar desde localStorage si existe
            const savedCart = localStorage.getItem('charlieCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
                updateCartUI();
            }

            // Event Listeners
            openCartBtn.addEventListener('click', toggleCartModal);
            closeCartBtn.addEventListener('click', toggleCartModal);
            generatePdfBtn.addEventListener('click', generateOrderPDF);

            // Delegación de eventos para botones "Añadir"
            productGrid.addEventListener('click', (e) => {
                const btn = e.target.closest('.add-to-cart-btn');
                if (btn) {
                    const id = btn.dataset.id;
                    addToCart(id);
                }
            });
            
            // Delegación de eventos para botones "Quitar" del carrito
            cartItemsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.remove-from-cart-btn');
                if (btn) {
                    const id = btn.dataset.id;
                    removeFromCart(id);
                }
            });

            // Ahora que todo está listo, cargar productos
            loadProductsFromCSV();
        }
        
        
        // --- LÓGICA DE PRODUCTOS ---
        
        function loadProductsFromCSV() {
            showLoading(true, "Cargando productos..."); // Mostrar spinner con nuevo texto
            showError(null);
            
            Papa.parse(GOOGLE_SHEET_URL, { // Usamos la URL constante
                download: true,
                header: true, // Asume que la primera fila es: nombre, descripcion, precio, foto
                skipEmptyLines: true,
                complete: (results) => {
                    showLoading(false); // Ocultar spinner
                    if (results.errors.length > 0) {
                        console.error("Errores de PapaParse:", results.errors);
                        showError("No se pudo cargar o procesar el archivo CSV. Revisa la URL y el formato.");
                        return;
                    }
                    
                    // Verificamos por las columnas que definimos ("Nombre Funko" y "Precio")
                    if (!results.data.length || !results.data[0]["Nombre Funko"] || !results.data[0].Precio) {
                         showError("El CSV parece estar vacío o no tiene las columnas 'Nombre Funko' y 'Precio'.");
                         return;
                    }

                    // Asignamos un ID único (el índice) a cada producto
                    // Filtramos para quitar los que digan "NO" o "FALSE" en Disponible. Los demás (vacío, SI, TRUE) se muestran.
                    allProducts = results.data.map((product, index) => ({
                        id: index.toString(),
                        ...product
                    })).filter(p => 
                        !p["Disponible?"] || (
                            p["Disponible?"].trim().toUpperCase() !== 'NO' && 
                            p["Disponible?"].trim().toUpperCase() !== 'FALSE'
                        )
                    );
                    
                    displayProducts();
                },
                error: (err) => {
                    showLoading(false);
                    console.error("Error al descargar:", err);
                    showError("Error de red. No se pudo descargar el archivo. Asegúrate que la URL sea correcta y pública.");
                }
            });
        }

        function displayProducts() {
            productGrid.innerHTML = ''; // Limpiar grid
            if (allProducts.length === 0) {
                productGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No hay productos para mostrar.</p>`;
                return;
            }

            allProducts.forEach((product) => {
                // Validar que el producto tenga lo mínimo
                if (!product["Nombre Funko"] || !product.Precio) {
                    console.warn("Producto omitido por falta de datos (Nombre o Precio):", product);
                    return;
                }
                
                // --- INICIO DE CORRECCIÓN DE PRECIO ---
                // Esta es la lógica que arregla los formatos "$1,100.00" y "$350,00"
                const priceFloat = getPriceAsNumber(product.Precio);
                // --- FIN DE CORRECCIÓN DE PRECIO ---

                if (isNaN(priceFloat)) {
                    console.warn("Producto omitido por precio inválido:", product);
                    return; // Omitir si el precio no es un número
                }


                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col transition-transform duration-300 hover:scale-105';
                
                const priceFormatted = formatCurrency(priceFloat); // Usamos el número limpio
                // Usamos la nueva columna "foto_url". Si no existe, usamos el placeholder.
                const placeholderImage = `https://placehold.co/400x400/374151/9CA3AF?text=${product["Nombre Funko"].substring(0, 10)}...`;

                card.innerHTML = `
                    <img src="${product.foto_url || placeholderImage}" 
                         alt="[Imagen de ${product["Nombre Funko"]}]" 
                         class="w-full h-48 sm:h-56 md:h-64 object-cover"
                         onerror="this.onerror=null; this.src='${placeholderImage}';">
                    
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-white mb-1 truncate">${product["Nombre Funko"]}</h3>
                        <!-- Usamos la columna Franquicia como descripción -->
                        <p class="text-sm text-gray-400 mb-3 flex-grow min-h-[40px]">${product.Franquicia || 'Sin descripción.'}</p>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-xl font-extrabold text-blue-400">${priceFormatted}</span>
                            <button 
                                class="add-to-cart-btn bg-blue-600 text-white text-sm font-bold py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors"
                                data-id="${product.id}">
                                Añadir
                            </button>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
            });
        }

        // --- LÓGICA DEL CARRITO ---

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            
            updateCartUI();
            saveCart();
            // Feedback visual
            openCartBtn.classList.add('transform', 'scale-125');
            setTimeout(() => {
                openCartBtn.classList.remove('transform', 'scale-125');
            }, 200);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartUI();
            saveCart();
        }

        /**
         * CORRECCIÓN: Esta función ahora maneja ambos casos:
         * 1. "$1,100.00" (coma de miles, punto decimal)
         * 2. "$350,00" (sin miles, coma decimal)
         */
        function getPriceAsNumber(price) {
            if (typeof price === 'number') return price;
            if (typeof price !== 'string') return 0;
            
            let priceString = price.replace("$", "").trim();
            
            // Detectar si el formato usa coma para decimales (ej. "350,00")
            // Lo detectamos si hay una coma Y NINGÚN punto.
            if (priceString.includes(',') && !priceString.includes('.')) {
                // Es formato "350,00". Reemplazamos coma por punto.
                priceString = priceString.replace(",", "."); 
            } else {
                // Es formato "1,100.00". Solo quitamos la coma de miles.
                priceString = priceString.replace(/,/g, ""); 
            }
            
            return parseFloat(priceString);
        }

        function updateCartUI() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500">Aún no has agregado productos.</p>';
                generatePdfBtn.disabled = true;
                generatePdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                cartItemsContainer.innerHTML = ''; // Limpiar items
                generatePdfBtn.disabled = false;
                generatePdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                cart.forEach(item => {
                    const priceNum = getPriceAsNumber(item.Precio);
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between py-3 border-b border-gray-700';
                    const itemTotal = formatCurrency(priceNum * item.quantity);
                    
                    itemEl.innerHTML = `
                        <div class="flex items-center gap-4">
                            <img src="${item.foto_url || `https://placehold.co/80x80/374151/9CA3AF?text=...`}" alt="[Imagen de ${item["Nombre Funko"]}]" class="w-16 h-16 object-cover rounded-md">
                            <div>
                                <h4 class="font-bold text-white">${item["Nombre Funko"]}</h4>
                                <p class="text-sm text-gray-400">${formatCurrency(priceNum)} x ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <span class="font-bold text-lg text-white">${itemTotal}</span>
                             <button class="remove-from-cart-btn text-xs text-red-400 hover:text-red-300 ml-2" data-id="${item.id}">
                                Quitar
                             </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
            }

            // Calcular total
            const total = cart.reduce((sum, item) => {
                const priceNum = getPriceAsNumber(item.Precio);
                return sum + (priceNum * item.quantity);
            }, 0);
            cartTotalEl.textContent = formatCurrency(total);

            // Actualizar contador del botón flotante
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCountEl.textContent = totalItems;
            cartCountEl.classList.toggle('hidden', totalItems === 0);
        }

        function saveCart() {
            localStorage.setItem('charlieCart', JSON.stringify(cart));
        }

        function toggleCartModal() {
            const isOpen = !cartModal.classList.contains('opacity-0');
            if (isOpen) {
                cartModal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-open');
            } else {
                updateCartUI(); // Asegurarse de que esté actualizado al abrir
                cartModal.classList.remove('opacity-0', 'pointer-events-none');
                document.body.classList.add('modal-open');
            }
        }

        // --- LÓGICA DE PDF ---

        function generateOrderPDF() {
            if (cart.length === 0) return;

            try {
                // Usar la variable jsPDF definida
                const doc = new jsPDF(); 
                const total = cart.reduce((sum, item) => {
                    const priceNum = getPriceAsNumber(item.Precio);
                    return sum + (priceNum * item.quantity);
                }, 0);
                
                let y = 20; // Posición vertical inicial

                // Título
                doc.setFontSize(22);
                doc.setFont("helvetica", "bold");
                doc.text("Pedido - Charlie's Collectibles", 105, y, { align: 'center' });
                y += 15;

                // Instrucciones
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.text("¡Gracias por tu interés! Sigue estos pasos para completar tu pedido:", 14, y);
                y += 8;

                doc.setFont("helvetica", "bold");
                doc.text("1. Envía este archivo PDF a la cuenta de Instagram:", 14, y);
                doc.setTextColor(0, 0, 255); // Azul
                doc.textWithLink("@charlie.leyva", 120, y, { url: 'https://www.instagram.com/charlie.leyva' });
                doc.setTextColor(0, 0, 0); // Reset color
                y += 8;

                doc.setFont("helvetica", "bold");
                doc.text("2. En el mensaje, coordinaremos el pago y los detalles de la entrega.", 14, y);
                y += 12;

                doc.setFontSize(9);
                doc.setFont("helvetica", "italic");
                doc.text("Nota: Esta es una venta de colección personal. El envío tiene un costo adicional.", 14, y);
                y += 10;
                doc.line(14, y, 196, y); // Línea divisoria
                y += 10;

                // Resumen del Pedido
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("Resumen de tu Pedido", 14, y);
                y += 10;

                // Cabeceras de la tabla
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("Cant.", 14, y);
                doc.text("Producto", 30, y);
                doc.text("P. Unitario", 140, y, { align: 'right' });
                doc.text("Total Item", 196, y, { align: 'right' });
                y += 5;
                doc.line(14, y, 196, y); // Línea divisoria
                y += 8;

                // Items del Carrito
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                cart.forEach(item => {
                    const priceNum = getPriceAsNumber(item.Precio);

                    doc.text(`${item.quantity}x`, 14, y);
                    
                    // Manejar nombres largos
                    const splitName = doc.splitTextToSize(item["Nombre Funko"], 105); // 105mm de ancho
                    doc.text(splitName, 30, y);
                    
                    doc.text(formatCurrency(priceNum), 140, y, { align: 'right' });
                    doc.text(formatCurrency(priceNum * item.quantity), 196, y, { align: 'right' });
                    
                    // Incrementar 'y' basado en la altura del texto del nombre
                    y += (splitName.length * 5) + 3; // 5mm por línea + 3mm de espacio
                });

                doc.line(14, y, 196, y); // Línea divisoria
                y += 10;

                // Total
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("TOTAL (MXN):", 120, y, { align: 'right' });
                doc.text(formatCurrency(total), 196, y, { align: 'right' });

                // Guardar PDF
                doc.save('pedido_charlie_collectibles.pdf');

            } catch (err) {
                console.error("Error al generar PDF:", err);
                // No usar alert()
                showError("Hubo un error al generar el PDF. Intenta de nuevo.");
            }
        }

        // --- FUNCIONES UTILITARIAS ---

        function showLoading(isLoading, message = "Cargando...") {
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                loadingSpinner.classList.add('flex');
                loadingText.textContent = message;
            } else {
                loadingSpinner.classList.add('hidden');
                loadingSpinner.classList.remove('flex');
            }
        }

        function showError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        function formatCurrency(value) {
            // Asegurarse de que el valor es un número
            const number = parseFloat(value);
            if (isNaN(number)) {
                return "$0.00";
            }
            // Asumimos MXN como moneda
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(number);
        }

    </script>

</body>
</html>
